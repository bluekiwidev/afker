# This workflow will build a golang project
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-go

name: Go

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g. v1.2.3). Required when creating a release via workflow_dispatch.'
        required: true
        default: ''

jobs:

#  build-linux-x64:
#    runs-on: ubuntu-latest
#    steps:
#    - uses: actions/checkout@v4
#    - name: Set up Go
#      uses: actions/setup-go@v4
#      with:
#        go-version: '1.25'
#    - name: Build artifact
#      run: go build -o linux-x64 -v ./...
#    - name: Test
#      run: go test -v ./...
#    - name: upload artifact
#      uses: actions/upload-artifact@v4.6.2
#      with:
#        name: linux-x64
#        path: linux-x64

#  build-linux-arm64:
#    runs-on: ubuntu-24.04-arm
#    steps:
#    - uses: actions/checkout@v4
#    - name: Set up Go
#      uses: actions/setup-go@v4
#      with:
#        go-version: '1.25'
#    - name: Build artifact
#      run: go build -o linux-arm64 -v ./...
#   - name: Test
#      run: go test -v ./...
#    - name: upload artifact
#      uses: actions/upload-artifact@v4.6.2
#      with:
#        name: linux-arm64
#        path: linux-arm64

  build-windows-x64:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.25'
    - name: Build artifact
      run: go build -o windows-x64.exe -v ./...
    - name: Test
      run: go test -v ./...
    - name: upload artifact
      uses: actions/upload-artifact@v4.6.2
      with:
        name: windows-x64.exe
        path: windows-x64.exe

#  build-windows-arm64:
#    runs-on: windows-11-arm
#    steps:
#    - uses: actions/checkout@v4
#    - name: Set up Go
#      uses: actions/setup-go@v4
#      with:
#        go-version: '1.25'
#    - name: Build artifact
#      run: go build -o windows-arm64.exe -v ./...
#    - name: Test
#      run: go test -v ./...
#    - name: upload artifact
#      uses: actions/upload-artifact@v4.6.2
#      with:
#        name: windows-arm64.exe
#        path: windows-arm64.exe

  build-macos-x64:
    runs-on: macos-13
    steps:
    - uses: actions/checkout@v4
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.25'
    - name: Build artifact
      run: go build -o macos-x64 -v ./...
    - name: Test
      run: go test -v ./...
    - name: upload artifact
      uses: actions/upload-artifact@v4.6.2
      with:
        name: macos-x64
        path: macos-x64

  build-macos-arm64:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.25'
    - name: Build artifact
      run: go build -o macos-arm64 -v ./...
    - name: Test
      run: go test -v ./...
    - name: upload artifact
      uses: actions/upload-artifact@v4.6.2
      with:
        name: macos-arm64
        path: macos-arm64

  release:
    needs: [build-windows-x64, build-macos-x64, build-macos-arm64]
    runs-on: ubuntu-latest
    # Run this job when the workflow was manually dispatched (so we can pass a version input)
    # or when a tag starting with 'v' was pushed.
    if: github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release_artifacts

      - name: Create release
        uses: ncipollo/release-action@v1
        with:
          # If this run was triggered by workflow_dispatch use the provided input, otherwise use the tag name
          tag: ${{ github.event_name == 'workflow_dispatch' ? github.event.inputs.version : github.ref_name }}
          name: Release ${{ github.event_name == 'workflow_dispatch' ? github.event.inputs.version : github.ref_name }}
          body: |
            ## Release Notes for ${{ github.event_name == 'workflow_dispatch' ? github.event.inputs.version : github.ref_name }}
            
            This release includes the following binaries:
            - Windows x64
            - macOS x64
            - macOS ARM64
          artifacts: "release_artifacts/**/*" # Use a glob pattern to find all files in the subdirectory
          token: ${{ secrets.GITHUB_TOKEN }}
